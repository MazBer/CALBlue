---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';
import { getCollection } from 'astro:content';

export const prerender = false;

const selectedTagRaw = Astro.url.searchParams.get('tag');
const searchQueryRaw = Astro.url.searchParams.get('q');
const selectedTag = selectedTagRaw && selectedTagRaw.length ? selectedTagRaw : null;
const searchQuery = searchQueryRaw && searchQueryRaw.length ? searchQueryRaw : null;
const sortBy = Astro.url.searchParams.get('sort') ?? 'pubDate-desc';

const tagId = (t: string) => t.toLowerCase().replace(/[^a-z0-9]+/g, '-');

let entries = await getCollection('articles', ({ data }) => !data.draft);

// Filter by tag
if (selectedTag) {
  entries = entries.filter((e) => e.data.tags.includes(selectedTag));
}

// Filter by search query
if (searchQuery) {
  const q = searchQuery.toLowerCase();
  entries = entries.filter((e) => {
    const title = e.data.title.toLowerCase();
    const description = e.data.description?.toLowerCase() ?? '';
    const tags = e.data.tags.join(' ').toLowerCase();
    return title.includes(q) || description.includes(q) || tags.includes(q);
  });
}

// Sort entries
const [sortField, sortDir] = sortBy.split('-');
entries.sort((a, b) => {
  let valA, valB;
  if (sortField === 'title') {
    valA = a.data.title.toLowerCase();
    valB = b.data.title.toLowerCase();
  } else {
    valA = a.data.pubDate.valueOf();
    valB = b.data.pubDate.valueOf();
  }

  if (valA < valB) return sortDir === 'asc' ? -1 : 1;
  if (valA > valB) return sortDir === 'asc' ? 1 : -1;
  return 0;
});

const allTags = Array.from(
  new Set(
    (await getCollection('articles', ({ data }) => !data.draft)).flatMap((e) => e.data.tags)
  )
).sort((a, b) => a.localeCompare(b));
---

<BaseLayout title="Articles | CALBlue" description="Articles from the CALBlue project.">
  <section class="w-full max-w-7xl mx-auto px-4 md:px-10 py-12 md:py-16">
    <div class="flex flex-col gap-3 mb-10">
      <h1 class="text-[#0a2a4d] dark:text-white text-4xl md:text-5xl font-display font-black tracking-tight">Articles</h1>
      <p class="text-gray-600 dark:text-gray-300 font-medium">Search and filter by tags.</p>

      <form id="filter-form" class="mt-4 flex flex-col gap-4" method="get" action={Astro.url.pathname}>
        <div class="flex flex-col md:flex-row gap-4 md:items-center md:justify-between">
          <input
            name="q"
            class="w-full md:max-w-sm bg-white dark:bg-[#1a2c38] border border-gray-200 dark:border-white/10 rounded-full px-5 py-3 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-primary"
            placeholder="Search articles..."
            type="search"
            value={searchQuery ?? ''}
          />

          <div class="flex items-center gap-3">
            <select
              name="sort"
              class="bg-white dark:bg-[#1a2c38] border border-gray-200 dark:border-white/10 rounded-full px-4 py-3 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-primary"
              onchange="this.form.submit()"
            >
              <option value="pubDate-desc" selected={sortBy === 'pubDate-desc'}>Newest</option>
              <option value="pubDate-asc" selected={sortBy === 'pubDate-asc'}>Oldest</option>
              <option value="title-asc" selected={sortBy === 'title-asc'}>Title (A-Z)</option>
              <option value="title-desc" selected={sortBy === 'title-desc'}>Title (Z-A)</option>
            </select>
            <button type="submit" class="hidden">Submit</button>
          </div>
        </div>

        <div class="mt-2 flex gap-2 flex-wrap">
          <input type="radio" name="tag" value="" checked={!selectedTag} id="tag-all" class="sr-only" onchange="this.form.submit()" />
          <label
            for="tag-all"
            class={`text-xs font-bold px-3 py-2 rounded-full transition-colors cursor-pointer ${
              !selectedTag ? 'bg-primary text-white' : 'bg-white dark:bg-[#1a2c38] text-gray-700 dark:text-gray-200'
            }`}>
            All
          </label>

          {allTags.map((t) => (
            <>
              <input
                type="radio"
                name="tag"
                value={t}
                checked={selectedTag === t}
                id={`tag-${tagId(t)}`}
                class="sr-only"
                onchange="this.form.submit()"
              />
              <label
                for={`tag-${tagId(t)}`}
                class={`text-xs font-bold px-3 py-2 rounded-full transition-colors cursor-pointer ${
                  selectedTag === t ? 'bg-primary text-white' : 'bg-white dark:bg-[#1a2c38] text-primary hover:bg-primary/10'
                }`}>
                {t}
              </label>
            </>
          ))}
        </div>
      </form>
    </div>

    <div id="cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
      {entries.map((entry) => (
        <PostCard
          href={`/articles/${entry.slug}`}
          title={entry.data.title}
          description={entry.data.description}
          pubDate={entry.data.pubDate}
          tags={entry.data.tags}
          coverImage={entry.data.coverImage}
          badge="ðŸ“ Article"
        />
      ))}
    </div>

    {entries.length === 0 && (
      <p id="empty" class="mt-10 text-center text-gray-600 dark:text-gray-300 font-medium">
        No results found.
      </p>
    )}
  </section>

  </BaseLayout>
