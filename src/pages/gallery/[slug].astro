---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { formatDate } from '../../utils/formatDate';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const entries = await getCollection('galleries', ({ data }) => !data.draft);
  return entries.map((entry) => ({ params: { slug: entry.slug }, props: { entry } }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();
---

<BaseLayout title={`${entry.data.title} | CALBlue`} description={entry.data.description ?? 'CALBlue gallery post'}>
  <article class="w-full max-w-5xl mx-auto px-4 md:px-10 py-12 md:py-16">
    <a class="text-primary font-bold inline-flex items-center gap-2" href="/gallery">
      <span class="material-symbols-outlined">arrow_back</span> Back to Gallery
    </a>

    <header class="mt-6">
      <h1 class="text-[#0a2a4d] dark:text-white text-4xl md:text-5xl font-display font-black tracking-tight">
        {entry.data.title}
      </h1>

      <div class="mt-4 flex flex-wrap items-center gap-3 text-sm font-bold text-gray-500 dark:text-gray-300">
        <span>{formatDate(entry.data.pubDate)}</span>
        {entry.data.location ? <span>• {entry.data.location}</span> : null}
        {entry.data.eventDate ? <span>• Event: {formatDate(entry.data.eventDate)}</span> : null}
        <span>• {entry.data.images?.length ?? 0} photos</span>
      </div>

      {entry.data.tags?.length ? (
        <div class="mt-4 flex flex-wrap gap-2">
          {entry.data.tags.map((t) => (
            <a class="text-xs font-bold px-3 py-2 rounded-full bg-primary/10 text-primary hover:bg-primary/20 transition-colors" href={`/gallery?tag=${encodeURIComponent(t)}`}>
              {t}
            </a>
          ))}
        </div>
      ) : null}

      {entry.data.coverImage ? (
        <div class="mt-8 rounded-3xl overflow-hidden shadow-lg border border-gray-200 dark:border-white/10">
          <img
            class="w-full h-auto"
            src={entry.data.coverImage}
            alt={entry.data.title}
            loading="lazy"
            decoding="async"
            referrerpolicy="no-referrer"
            onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=1600&q=60';"
          />
        </div>
      ) : null}
    </header>

    <div class="mt-10 prose prose-lg max-w-none dark:prose-invert">
      <Content />
    </div>

    <section class="mt-12">
      <h2 class="text-2xl font-display font-black text-[#0a2a4d] dark:text-white">Photos</h2>

      <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {(entry.data.images ?? []).map((img) => (
          <figure class="rounded-2xl overflow-hidden border border-gray-200 dark:border-white/10 bg-white dark:bg-[#1a2c38]">
            <img
              class="w-full h-64 object-cover"
              src={img.src}
              alt={img.alt}
              loading="lazy"
              decoding="async"
              referrerpolicy="no-referrer"
              onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=1200&q=60';"
            />
            {img.caption ? <figcaption class="p-3 text-sm font-medium text-gray-600 dark:text-gray-300">{img.caption}</figcaption> : null}
          </figure>
        ))}
      </div>
    </section>
  </article>
</BaseLayout>
